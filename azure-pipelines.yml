trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  name: 'loanHub-self'


variables:
  buildConfiguration: Release

steps:
  - task: UseDotNet@2
    displayName: "Use .NET SDK"
    inputs:
      packageType: "sdk"
      version: "9.0.x"

  - script: dotnet --info
    displayName: "dotnet --info"

  - task: DotNetCoreCLI@2
    displayName: "Restore"
    inputs:
      command: "restore"
      projects: "**/*.sln"

  - task: DotNetCoreCLI@2
    displayName: "Build"
    inputs:
      command: "build"
      projects: "LoanHub.SearchEngine.sln"
      arguments: "--configuration $(buildConfiguration) --no-restore"

- powershell: |
    $testsDir = Join-Path $env:BUILD_SOURCESDIRECTORY "tests"
    if (Test-Path $testsDir) {
      $hasTests = Get-ChildItem -Path $testsDir -Recurse -Filter *.csproj -ErrorAction SilentlyContinue | Select-Object -First 1
      if ($null -ne $hasTests) {
        dotnet test .\LoanHub.SearchEngine.sln --configuration "$(buildConfiguration)" --no-build
      } else {
        Write-Host "No test projects found under ./tests - skipping."
      }
    } else {
      Write-Host "No ./tests directory - skipping."
    }
  displayName: "Test (if present)"



  - task: DotNetCoreCLI@2
    displayName: "Publish API"
    inputs:
      command: "publish"
      publishWebProjects: false
      projects: "src/LoanHub.Search.Api/LoanHub.Search.Api.csproj"
      arguments: "--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/app"
      zipAfterPublish: true

  - task: PublishBuildArtifacts@1
    displayName: "Publish artifact"
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)/app"
      ArtifactName: "drop"
