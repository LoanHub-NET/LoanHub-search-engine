trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: Release

steps:
  - task: UseDotNet@2
    displayName: "Use .NET SDK"
    inputs:
      packageType: "sdk"
      version: "9.0.x"

  - script: dotnet --info
    displayName: "dotnet --info"

  - task: DotNetCoreCLI@2
    displayName: "Restore"
    inputs:
      command: "restore"
      projects: "**/*.sln"

  - task: DotNetCoreCLI@2
    displayName: "Build"
    inputs:
      command: "build"
      projects: "**/*.sln"
      arguments: "--configuration $(buildConfiguration) --no-restore"

  # Testy odpalamy tylko jeśli istnieją projekty testowe
  - bash: |
      set -e
      if [ -d "tests" ] && find tests -name "*.csproj" | grep -q .; then
        dotnet test **/*.sln --configuration $(buildConfiguration) --no-build
      else
        echo "No test projects found under ./tests - skipping."
      fi
    displayName: "Test (if present)"

  - task: DotNetCoreCLI@2
    displayName: "Publish API"
    inputs:
      command: "publish"
      publishWebProjects: false
      projects: "src/LoanHub.Search.Api/LoanHub.Search.Api.csproj"
      arguments: "--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/app"
      zipAfterPublish: true

  - task: PublishBuildArtifacts@1
    displayName: "Publish artifact"
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)/app"
      ArtifactName: "drop"
